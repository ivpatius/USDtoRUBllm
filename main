import requests
import json
from datetime import datetime
import ssl

# –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É SSL (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
ssl._create_default_https_context = ssl._create_unverified_context

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BASE_URL = "http://localhost:11434"
MODEL_NAME = "gpt-oss:latest"

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö SSL-–ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–ª—è requests
session = requests.Session()
session.verify = False


def chat_with_ollama(message):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å Ollama"""
    url = f"{BASE_URL}/api/chat"
    headers = {"Content-Type": "application/json"}
    data = {
        "model": MODEL_NAME,
        "messages": [{"role": "user", "content": message}],
        "stream": False
    }

    try:
        response = session.post(url, headers=headers, json=data, timeout=30)
        response.raise_for_status()
        return response.json()
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ Ollama: {e}")
        return None


def get_rates_no_ssl():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ —Å –æ–±—Ö–æ–¥–æ–º SSL"""
    rates = []

    # 1. –¶–ë –†–§ —Å –ø–æ–ª–Ω—ã–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º SSL
    try:
        url = "https://www.cbr.ru/scripts/XML_daily.asp"
        today = datetime.now().strftime("%d/%m/%Y")
        params = {"date_req": today}

        response = session.get(url, params=params, timeout=15)
        if response.status_code == 200:
            import xml.etree.ElementTree as ET
            root = ET.fromstring(response.content)

            for valute in root.findall('Valute'):
                if valute.get('ID') == 'R01235':
                    value = valute.find('Value').text.replace(',', '.')
                    nominal = int(valute.find('Nominal').text)
                    rate = round(float(value) / nominal, 4)
                    rates.append({
                        "source": "–¶–ë –†–§",
                        "rate": rate,
                        "type": "–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π"
                    })
                    break
    except Exception as e:
        print(f"–¶–ë –†–§ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω: {e}")

    # 2. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ HTTP-–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –±–µ–∑ SSL
    http_sources = [
        "http://api.fixer.io/latest?base=USD&symbols=RUB",
        "http://rate-exchange.appspot.com/currency?from=USD&to=RUB",
        "http://openexchangerates.org/api/latest.json?app_id=demo"  # demo key
    ]

    for url in http_sources:
        try:
            response = session.get(url, timeout=10)
            if response.status_code == 200:
                data = response.json()
                if 'rates' in data and 'RUB' in data['rates']:
                    rate = round(data['rates']['RUB'], 4)
                    source = url.split('/')[2]
                    rates.append({
                        "source": source,
                        "rate": rate,
                        "type": "–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π"
                    })
                    break  # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ
        except:
            continue

    # 3. –ó–∞–ø–∞—Å–Ω—ã–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –≤—Å—ë –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ
    if not rates:
        print("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø–∞—Å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...")
        rates = [
            {"source": "–ü—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å", "rate": 95.5, "type": "–æ—Ü–µ–Ω–æ—á–Ω—ã–π"},
            {"source": "–ü—Ä–∏–º–µ—Ä–Ω—ã–π –∫—É—Ä—Å", "rate": 96.2, "type": "–æ—Ü–µ–Ω–æ—á–Ω—ã–π"}
        ]

    return rates


def get_rate_from_backup_sources():
    """–†–µ–∑–µ—Ä–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞"""

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ-API –∏—Å—Ç–æ—á–Ω–∏–∫–∏
    backup_sources = [
        {
            "name": "–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä—Å–∞",
            "rate": 95.75,
            "url": "https://example.com/rates"
        }
    ]

    return backup_sources


def create_mock_analysis():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"""

    # –¢–µ–∫—É—â–∏–µ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é)
    mock_data = {
        "cbr_official": 95.5247,
        "market_average": 96.15,
        "spread": 0.85,
        "last_updated": datetime.now().isoformat()
    }

    return mock_data


def main():
    """–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å"""
    print("üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –¥–æ–ª–ª–∞—Ä–∞ (–æ–±—Ö–æ–¥ SSL)...")

    # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º SSL-–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    import urllib3
    urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

    # –ü–æ–ª—É—á–∞–µ–º –∫—É—Ä—Å—ã
    rates = get_rates_no_ssl()

    if not rates:
        print("‚ö†Ô∏è –ù–∏ –æ–¥–∏–Ω API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...")
        rates = [
            {"source": "–¶–ë –†–§ (–æ—Ü–µ–Ω–æ—á–Ω–æ)", "rate": 95.52, "type": "–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π"},
            {"source": "–†—ã–Ω–æ—á–Ω—ã–π –∫—É—Ä—Å (–æ—Ü–µ–Ω–æ—á–Ω–æ)", "rate": 96.15, "type": "—Ä—ã–Ω–æ—á–Ω—ã–π"}
        ]

    print(f"üìä –ü–æ–ª—É—á–µ–Ω–æ {len(rates)} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤")

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è LLM
    current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    prompt = f"""
–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –°–®–ê –∫ —Ä–æ—Å—Å–∏–π—Å–∫–æ–º—É —Ä—É–±–ª—é –Ω–∞ {current_time}

–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
{chr(10).join([f"- {r['source']} ({r['type']}): {r['rate']} —Ä—É–±./–¥–æ–ª–ª." for r in rates])}

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∫—Ä–∞—Ç–∫–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
    "current_rates": {[r['rate'] for r in rates]},
    "average_rate": {sum([r['rate'] for r in rates]) / len(rates) if rates else 0},
    "analysis": "–∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏",
    "recommendation": "–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è"
}}
"""

    print("ü§ñ –ê–Ω–∞–ª–∏–∑ –≤ LLM...")
    result = chat_with_ollama(prompt)

    if result:
        response = result['message']['content']
        print("\n" + "=" * 60)
        print("üìã –ê–ù–ê–õ–ò–ó –ö–£–†–°–ê USD/RUB")
        print("=" * 60)
        print(response)

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        output = {
            "timestamp": datetime.now().isoformat(),
            "rates": rates,
            "analysis": response,
            "prompt": prompt
        }

        with open("currency_analysis_result.json", "w", encoding="utf-8") as f:
            json.dump(output, f, ensure_ascii=False, indent=2)

        print(f"\n‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ currency_analysis_result.json")
    else:
        print("‚ùå LLM –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç")

        # –í—ã–≤–æ–¥–∏–º —Ö–æ—Ç—è –±—ã –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã
        print("\nüìà –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫—É—Ä—Å—ã:")
        for rate in rates:
            print(f"- {rate['source']}: {rate['rate']} ‚ÇΩ/$")


def ultra_simple_version():
    """–°–≤–µ—Ä—Ö–ø—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"""

    # –î–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ LLM
    current_data = {
        "date": datetime.now().strftime("%d.%m.%Y %H:%M"),
        "rates": {
            "cbr_official": 95.52,
            "sberbank": 96.10,
            "tinkoff": 95.85,
            "market_average": 96.0
        }
    }

    prompt = f"""
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –Ω–∞ {current_data['date']}:

–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –¶–ë: {current_data['rates']['cbr_official']} —Ä—É–±.
–°–±–µ—Ä–±–∞–Ω–∫: {current_data['rates']['sberbank']} —Ä—É–±.
–¢–∏–Ω—å–∫–æ—Ñ—Ñ: {current_data['rates']['tinkoff']} —Ä—É–±.
–°—Ä–µ–¥–Ω–∏–π —Ä—ã–Ω–æ—á–Ω—ã–π: {current_data['rates']['market_average']} —Ä—É–±.

–í—ã–≤–µ–¥–∏ JSON-–æ—Ç–≤–µ—Ç:
{{
    "analysis": "–≤–∞—à –∞–Ω–∞–ª–∏–∑",
    "recommendation": "—Å–æ–≤–µ—Ç",
    "trend": "–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"
}}
"""

    print("üöÄ –ó–∞–ø—É—Å–∫ —Å–≤–µ—Ä—Ö–ø—Ä–æ—Å—Ç–æ–π –≤–µ—Ä—Å–∏–∏...")
    result = chat_with_ollama(prompt)

    if result:
        print("\nüéØ –†–µ–∑—É–ª—å—Ç–∞—Ç:")
        print(result['message']['content'])
    else:
        print("LLM –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")


if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å
    main()

    # –ï—Å–ª–∏ –≤—Å—ë –µ—â–µ –ø—Ä–æ–±–ª–µ–º—ã, –∑–∞–ø—É—Å–∫–∞–µ–º —Å–≤–µ—Ä—Ö–ø—Ä–æ—Å—Ç—É—é –≤–µ—Ä—Å–∏—é
    if False:  # –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ True –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Å—Ç–æ–π –≤–µ—Ä—Å–∏–∏
        ultra_simple_version()
